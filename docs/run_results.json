{"metadata": {"dbt_schema_version": "https://schemas.getdbt.com/dbt/run-results/v6.json", "dbt_version": "1.9.10", "generated_at": "2025-12-18T09:49:10.739006Z", "invocation_id": "c6c88ef7-3d6f-4f49-b1ab-fa033515c266", "env": {}}, "results": [{"status": "success", "timing": [{"name": "compile", "started_at": "2025-12-18T09:49:04.622726Z", "completed_at": "2025-12-18T09:49:04.630923Z"}, {"name": "execute", "started_at": "2025-12-18T09:49:04.631377Z", "completed_at": "2025-12-18T09:49:10.730328Z"}], "thread_id": "Thread-1 (worker)", "execution_time": 6.108815670013428, "adapter_response": {"_message": "OK", "rows_affected": -1}, "message": "OK", "failures": null, "unique_id": "model.dbt_dataplatform.fait_demande_et_radiation_annee", "compiled": true, "compiled_code": "/**\n *\n * Description :    Alimentation de la table de fait demande et radiation\n * Fr\u00e9quence :      Annuel\n * Mode :           Annule et remplace\n * Source:          int_demande_et_radiation_sne\n * Cible :          fait_demande_et_radiation_annee  \n\n */\n\n\n\n\nwith\n\n-------------------------------------------------------------------\n--*********************** TABLE EN ENTREE *************************\n-------------------------------------------------------------------\n \ncte_demande_et_radiation_sne as\n(\n    select \n        [demande_et_radiation_sne_millesime],\n        [demande_et_radiation_sne_millesime_date],\n        -- [demande_et_radiation_sne_millesime_last_flag],\n        -- [demande_numero],\n        [demande_id],\n        [demande_creation_date],\n        [demande_motif_premier_code],\n        [demande_nouvelle_flag],\n        -- [demande_anciennete_jour_nombre],\n        [demande_anciennete_mois_nombre],\n        [demande_anciennete_annee_nombre],\n        -- [cerfa_version_code],\n        -- [demandeur_type_code],\n        -- [demandeur_naissance_date],\n        [demandeur_age],\n        [demandeur_age_tranche_code],\n        -- [demandeur_statut_professionnel_code],\n        -- [demandeur_situation_familiale_code],\n        -- [demandeur_composition_familiale_code],\n        -- [demandeur_revenu_mensuel_montant],\n        [foyer_taille],\n        [foyer_taille_plafond],\n        -- [cotitulaire_nombre],\n        -- [personne_a_charge_nombre],\n        -- [unite_de_consommation_nombre],\n        -- [handicape_nombre], \n        [foyer_personne_isole_flag],\n        [foyer_couple_flag],\n        [foyer_famille_monoparentale_flag],\n        [foyer_enfant_nombre],\n        -- [foyer_conjoint_age],\n        -- [foyer_couple_age], \n        [foyer_jeune_menage],\n        [foyer_revenu_mensuel_montant],\n        -- [foyer_revenu_fiscal_1_montant],\n        [foyer_revenu_fiscal_2_montant],\n        [foyer_revenu_total_mensuel_montant],\n        [foyer_revenu_total_par_uc_mensuel_montant],\n        -- [apl_mensuel_montant],\n        -- [logement_actuel_categorie_logement_code],\n        -- [logement_actuel_piece_nombre_code],\n        [logement_actuel_mode_logement_code],\n        [logement_actuel_zone_plafond_ressource_code],\n        [logement_actuel_commune_code],\n        -- [logement_actuel_arrondissement_code],\n        -- [logement_recherche_categorie_logement_code],\n        [logement_recherche_piece_nombre_code],\n        -- [logement_recherche_commune_code],\n        -- [logement_recherche_zone_plafond_ressource_code],\n        -- [logement_recherche_arrondissement_code],\n        -- [logement_rpls_id],\n        -- [logement_attribue_piece_nombre_code],\n        -- [logement_attribue_commune_code],\n        -- [logement_attribue_arrondissement_code],\n        -- [logement_attribue_zone_plafond_ressource_code],\n        [attribution_date],\n        -- [attribution_delai_jour_nombre],\n        [attribution_delai_mois_nombre],\n        [attribution_flag],\n        [mutation_flag],\n        [piece_nombre_adequation_code],\n        -- [reservataire_type_code],\n        -- [radiation_date],\n        [radiation_motif_code],\n        [radiation_hors_attribution_flag],\n        -- [radiation_flag],\n        -- [radiation_siren_numero],\n        -- [dalo_statut_code],\n        [dalo_flag],\n        [qpv_flag],\n        [demande_et_radiation_sne_hk],\n        -- [demande_et_radiation_sne_bk],\n        -- [logement_attribue_zone_plafond_ressource_hk],\n        -- [reservataire_type_hk],\n        [radiation_motif_hk],\n        -- [dalo_statut_hk],\n        -- [logement_recherche_categorie_logement_hk],\n        [logement_recherche_piece_nombre_hk],\n        -- [logement_recherche_zone_plafond_ressource_hk],\n        -- [logement_recherche_commune_hk],\n        -- [logement_recherche_commune_bk],\n        -- [logement_recherche_arrondissement_hk],\n        -- [logement_recherche_arrondissement_bk],\n        -- [logement_actuel_categorie_logement_hk],\n        -- [logement_actuel_piece_nombre_hk],\n        [logement_actuel_mode_logement_hk],\n        -- [logement_actuel_zone_plafond_ressource_hk],\n        [logement_actuel_commune_hk],\n        -- [logement_actuel_commune_bk],\n        -- [logement_actuel_arrondissement_hk],\n        -- [logement_actuel_arrondissement_bk],\n        -- [demandeur_composition_familiale_hk],\n        -- [demandeur_situation_familiale_hk],\n        -- [demandeur_statut_professionnel_hk],\n        [demandeur_age_tranche_hk],\n        [demande_motif_premier_hk]\n             \n\n    from\n        \"wh_dp_silver\".\"dbo\".\"demande_et_radiation_sne\"\n\n),\n\ncte_dim_demande_anciennete_tranche as\n(\n    select \n        demande_anciennete_tranche_hk\n        , demande_anciennete_tranche_code\n        , demande_anciennete_tranche_min\n        , demande_anciennete_tranche_max\n    from \n        \"wh_dp_gold\".\"dbo\".\"dim_demande_anciennete_tranche\"\n),\n\ncte_ref_ressource_plafond as\n(\n    select\n        taille\n        , zone_ps\n        , annee\n        , plai\n        , pls\n        , plus\n    from \n        \"wh_dp_bronze\".\"seed\".\"ref_ressource_plafond\"\n),\n\ncte_map_composition_familiale as\n(\n    select\n        composition_familiale_code\n        , foyer_personne_isole_flag\n        , foyer_couple_flag\n        , foyer_famille_monoparentale_flag\n        , foyer_enfant_nombre\n    from \n        \"wh_dp_bronze\".\"seed\".\"map_composition_familiale\"\n\n),\n\ncte_dim_ressource_par_uc_tranche as\n(\n    select \n        ressource_par_uc_tranche_hk\n        , ressource_par_uc_tranche_code\n        , ressource_par_uc_tranche_min\n        , ressource_par_uc_tranche_max\n    from \n        \"wh_dp_gold\".\"dbo\".\"dim_ressource_par_uc_tranche\"\n\n),\n\ncte_commune as \n(\n    select commune_code\n        , departement_code\n        , epci_code\n    from \"wh_dp_gold\".\"dbo\".\"dim_commune\"\n) ,\n\ncte_departement as \n(\n    select \n        departement_code\n        , region_code\n    from \"wh_dp_gold\".\"dbo\".\"dim_departement\"\n), \n\ncte_geographie as\n(\n    select \n        commune.commune_code\n        , commune.departement_code\n        , commune.epci_code\n        , departement.region_code\n    from \n        cte_commune commune\n        inner join cte_departement departement on (commune.departement_code = departement.departement_code)\n),\n\n\n \n------------------------------------------------------------------\n--*************************** FILTRES *****************************\n-------------------------------------------------------------------\n\n\n-------------------------------------------------------------------\n--************************* TRAITEMENTS ***************************\n-------------------------------------------------------------------\n-- liste des communes recherchees et leur g\u00e9ographie\ncte_demande_commune_recherche as \n(\n    select \n         \n        rech.demande_et_radiation_sne_hk,\n        rech.demande_commune_recherche_ordre_priorite,  \n        rech.commune_code,\n        geo.departement_code,\n        geo.epci_code,\n        geo.region_code\n    from \n        [wh_dp_silver].[dbo].[demande_commune_recherche] rech\n        inner join cte_geographie geo on geo.commune_code = rech.commune_code\n       \n),\n\ncte_localisation_attribuee as \n(\n    select \n        dem.demande_et_radiation_sne_hk\n        , case\n            -- Commune 1er choix\n            when geo_recherche.commune_code = geo_attribue.commune_code \n                and geo_recherche.demande_commune_recherche_ordre_priorite = 0\n            then 'commune_1er_choix'\n            \n            -- Commune autre choix\n            when geo_recherche.commune_code = geo_attribue.commune_code \n                and geo_recherche.demande_commune_recherche_ordre_priorite <> 0\n            then 'commune_autre_choix'\n            \n            -- Commune EPCI souhait\u00e9\n            when geo_recherche.epci_code = geo_attribue.epci_code\n                and geo_recherche.epci_code is not null\n            then 'commune_epci_souhait\u00e9'\n            \n            -- Commune du d\u00e9partement\n            when geo_recherche.departement_code = geo_attribue.departement_code\n                and geo_recherche.departement_code is not null\n            then 'autre_commune_departement'\n            \n            -- Autre r\u00e9gion commune\n            when geo_recherche.region_code = geo_attribue.region_code\n                and geo_recherche.region_code is not null\n            then 'autre_commune_region'\n            \n            else 'autre'\n        end as location_attribuee_code\n    \n    from [wh_dp_silver].[dbo].[demande_et_radiation_sne] dem\n   \n    left join cte_demande_commune_recherche geo_recherche\n        on (geo_recherche.demande_et_radiation_sne_hk = dem.demande_et_radiation_sne_hk and dem.attribution_flag = 1)\n    left join cte_geographie geo_attribue\n        on (geo_attribue.commune_code = dem.logement_attribue_commune_code and dem.attribution_flag = 1)\n    \n\n),\n\n-- on remonte uniquement la meilleure adequation avec la commune attribuee parmi toutes les communes recherch\u00e9es\ncte_localisation_attribuee_unique as (\n    select *\n    from (\n        select *,\n            row_number() over (\n                partition by demande_et_radiation_sne_hk\n                order by \n                    case location_attribuee_code\n                        when 'commune_1er_choix' then 1\n                        when 'commune_autre_choix' then 2\n                        when 'commune_epci_souhait\u00e9' then 3\n                        when 'autre_commune_departement' then 4\n                        when 'autre_commune_region' then 5\n                        else 6\n                    end\n            ) as rn\n        from cte_localisation_attribuee\n    ) t\n    where rn = 1\n),\n\n \n-- Pr\u00e9paration des axes d'analyses \ncte_transform_demande_et_radiation_sne as\n(\n    select\n        sne.*\n        , anciennete.demande_anciennete_tranche_code\n        , anciennete.demande_anciennete_tranche_hk\n        , \n    case\n        when sne.foyer_revenu_fiscal_2_montant is null then 'N/A'\n        when sne.foyer_revenu_fiscal_2_montant <= 0 then '0'\n        when sne.foyer_revenu_fiscal_2_montant > 0 and sne.foyer_revenu_fiscal_2_montant <= ressource.plai then 'PLAI'\n        when sne.foyer_revenu_fiscal_2_montant > ressource.plai and sne.foyer_revenu_fiscal_2_montant <= ressource.plus then 'PLAI_PLUS'\n        when sne.foyer_revenu_fiscal_2_montant > ressource.plus and sne.foyer_revenu_fiscal_2_montant <= ressource.pls then 'PLUS_PLS'\n        when sne.foyer_revenu_fiscal_2_montant > ressource.pls then 'PLS'\n        else 'N/A'\n    end\n    as revenu_plafond_tranche_code\n        , isnull(map_composition.composition_familiale_code,  'autres' )\n                as composition_familiale_code\n        , isnull(uc.ressource_par_uc_tranche_code,'N/A' )\n                as ressource_par_uc_tranche_code\n        , isnull(localisation.location_attribuee_code,'N/A' )\n                as location_attribuee_code \n\n    from \n        cte_demande_et_radiation_sne sne  \n    left join cte_dim_demande_anciennete_tranche anciennete \n        on (    sne.demande_anciennete_annee_nombre between anciennete.demande_anciennete_tranche_min and anciennete.demande_anciennete_tranche_max) \n    left join cte_ref_ressource_plafond ressource\n        on (    sne.foyer_taille_plafond = ressource.taille and sne.logement_actuel_zone_plafond_ressource_code = ressource.zone_ps and sne.demande_et_radiation_sne_millesime = ressource.annee)\n    left join cte_map_composition_familiale map_composition \n        on (    sne.foyer_personne_isole_flag = map_composition.foyer_personne_isole_flag\n            and sne.foyer_couple_flag = map_composition.foyer_couple_flag\n            and sne.foyer_famille_monoparentale_flag = map_composition.foyer_famille_monoparentale_flag\n            and sne.foyer_enfant_nombre = map_composition.foyer_enfant_nombre)\n    left join cte_dim_ressource_par_uc_tranche uc \n        on (    sne.foyer_revenu_total_par_uc_mensuel_montant between uc.ressource_par_uc_tranche_min and uc.ressource_par_uc_tranche_max)\n    left join cte_localisation_attribuee_unique localisation\n        on (localisation.demande_et_radiation_sne_hk = sne.demande_et_radiation_sne_hk)\n     \n\n),\n \n\n\n -- Calcul des cl\u00e9s techniques pour celles qui ne sont pas directement r\u00e9cup\u00e9r\u00e9es de la couche silver\ncte_hk_calc_demande_et_radiation_sne as\n (\n    select     \n        cte_transform_demande_et_radiation_sne.*\n        , \n     \n        HASHBYTES('SHA2_256', \n    \n        cast(revenu_plafond_tranche_code as varchar(max))\n    \n)  \n \n as revenu_plafond_tranche_hk\n        , \n     \n        HASHBYTES('SHA2_256', \n    \n        cast(composition_familiale_code as varchar(max))\n    \n)  \n \n as composition_familiale_hk\n        , \n     \n        HASHBYTES('SHA2_256', \n    \n        cast(ressource_par_uc_tranche_code as varchar(max))\n    \n)  \n \n as ressource_par_uc_tranche_hk\n        , \n     \n        HASHBYTES('SHA2_256', \n    \n        cast(location_attribuee_code as varchar(max))\n    \n)  \n \n as location_attribuee_hk\n\n  \n    from \n        cte_transform_demande_et_radiation_sne\n ),\n        \n\n-------------------------------------------------------------------\n--************************ ETAPE FINALE **************************\n-------------------------------------------------------------------\n \ncte_finale as\n(\n    select\n        *\n        , \n    CAST(SYSDATETIMEOFFSET() AT TIME ZONE 'Romance Standard Time' AS datetime2(3))\n as _meta_loaded_at\n    from\n        cte_hk_calc_demande_et_radiation_sne\n)\n\nselect \n    *\nfrom \n    cte_finale", "relation_name": "\"wh_dp_gold\".\"dbo\".\"fait_demande_et_radiation_annee\"", "batch_results": null}], "elapsed_time": 8.038256168365479, "args": {"strict_mode": false, "partial_parse": true, "state_modified_compare_vars": false, "project_dir": "C:\\Users\\slhuissier\\dbt-projects\\dbt_dataplatform", "require_explicit_package_overrides_for_builtin_materializations": true, "profiles_dir": "C:\\Users\\slhuissier\\dbt-projects\\dbt_dataplatform", "partial_parse_file_diff": true, "source_freshness_run_project_hooks": false, "indirect_selection": "eager", "log_level_file": "debug", "log_format_file": "debug", "static_parser": true, "printer_width": 80, "select": ["fait_demande_et_radiation_annee"], "vars": {}, "print": true, "skip_nodes_if_on_run_start_fails": false, "log_level": "info", "populate_cache": true, "require_resource_names_without_spaces": false, "require_nested_cumulative_type_params": false, "require_batched_execution_for_custom_microbatch_strategy": false, "show_resource_report": false, "state_modified_compare_more_unrendered_values": false, "use_colors": true, "version_check": true, "invocation_command": "dbt run -s fait_demande_et_radiation_annee", "send_anonymous_usage_stats": true, "favor_state": false, "empty": false, "log_file_max_bytes": 10485760, "quiet": false, "log_format": "default", "log_path": "C:\\Users\\slhuissier\\dbt-projects\\dbt_dataplatform\\logs", "require_yaml_configuration_for_mf_time_spines": false, "warn_error_options": {"include": [], "exclude": []}, "write_json": true, "cache_selected_only": false, "macro_debugging": false, "introspect": true, "use_colors_file": true, "exclude": [], "defer": false, "which": "run"}}